<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Gate Scanner ‚Äî EventPass</title>
<style>
  :root{
    --primary:#2563eb;
    --primary-dark:#1e40af;
    --secondary:#8b5cf6;
    --bg:#0f172a;
    --bg-light:#1e293b;
    --card:#ffffff;
    --text:#f8fafc;
    --text-muted:#94a3b8;
    --border:#334155;
    --success:#10b981;
    --warning:#f59e0b;
    --danger:#ef4444;
    --accent-gradient:linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  }
  
  *{box-sizing:border-box;margin:0;padding:0}
  
  body{
    font-family:'Inter',system-ui,-apple-system,sans-serif;
    background:var(--bg);
    color:var(--text);
    line-height:1.6;
    min-height:100vh;
  }
  
  .wrap{
    max-width:1200px;
    margin:0 auto;
    padding:20px;
  }
  
  /* Header */
  header{
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding:20px 0;
    margin-bottom:32px;
    border-bottom:1px solid var(--border);
  }
  
  .logo{
    display:flex;
    align-items:center;
    gap:12px;
  }
  
  .logo-icon{
    width:36px;
    height:36px;
    background:var(--accent-gradient);
    border-radius:8px;
    display:flex;
    align-items:center;
    justify-content:center;
    font-weight:bold;
    font-size:18px;
  }
  
  header h1{
    font-size:20px;
    font-weight:700;
    background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    -webkit-background-clip:text;
    -webkit-text-fill-color:transparent;
    background-clip:text;
  }
  
  nav{
    display:flex;
    gap:20px;
    align-items:center;
  }
  
  nav a{
    color:var(--text-muted);
    text-decoration:none;
    font-weight:500;
    transition:color 0.3s;
    font-size:14px;
  }
  
  nav a:hover{
    color:var(--text);
  }
  
  /* Page Header */
  .page-header{
    margin-bottom:32px;
  }
  
  .page-header h2{
    font-size:32px;
    margin-bottom:8px;
  }
  
  .page-header p{
    color:var(--text-muted);
    font-size:16px;
  }
  
  /* Grid Layout */
  .grid{
    display:grid;
    grid-template-columns:1fr 380px;
    gap:24px;
  }
  
  /* Cards */
  .card{
    background:var(--bg-light);
    border:1px solid var(--border);
    border-radius:12px;
    padding:24px;
    margin-bottom:24px;
  }
  
  .card h3{
    font-size:20px;
    margin-bottom:20px;
    display:flex;
    align-items:center;
    gap:8px;
  }
  
  .card h4{
    font-size:16px;
    margin:20px 0 12px;
    padding-top:16px;
    border-top:1px solid var(--border);
  }
  
  /* Scanner */
  #reader{
    width:100%;
    max-width:500px;
    border-radius:12px;
    overflow:hidden;
    border:2px solid var(--border);
    background:#000;
    margin:0 auto;
  }
  
  .scan-status{
    margin-top:20px;
    padding:16px;
    border-radius:8px;
    text-align:center;
    font-weight:600;
    font-size:15px;
    min-height:60px;
    display:flex;
    align-items:center;
    justify-content:center;
  }
  
  .status-idle{
    background:rgba(148,163,184,0.1);
    color:var(--text-muted);
  }
  
  .status-scanning{
    background:rgba(139,92,246,0.2);
    color:var(--secondary);
    animation:pulse 2s infinite;
  }
  
  .status-success{
    background:rgba(16,185,129,0.2);
    color:var(--success);
  }
  
  .status-error{
    background:rgba(239,68,68,0.2);
    color:var(--danger);
  }
  
  .status-offline{
    background:rgba(245,158,11,0.2);
    color:var(--warning);
  }
  
  @keyframes pulse{
    0%, 100%{opacity:1}
    50%{opacity:0.6}
  }
  
  /* Offline Badge */
  .offline-badge{
    display:inline-flex;
    align-items:center;
    gap:8px;
    padding:8px 16px;
    background:rgba(245,158,11,0.2);
    color:var(--warning);
    border-radius:20px;
    font-size:13px;
    font-weight:600;
    margin-top:12px;
  }
  
  .offline-badge .pulse-dot{
    width:8px;
    height:8px;
    background:var(--warning);
    border-radius:50%;
    animation:pulse 2s infinite;
  }
  
  /* Form Elements */
  .form-group{
    margin-bottom:16px;
  }
  
  label{
    display:block;
    font-size:13px;
    color:var(--text-muted);
    margin-bottom:6px;
    font-weight:500;
    text-transform:uppercase;
    letter-spacing:0.5px;
  }
  
  input{
    width:100%;
    padding:12px;
    border-radius:8px;
    border:1px solid var(--border);
    font-size:14px;
    background:rgba(255,255,255,0.05);
    color:var(--text);
    transition:all 0.3s;
  }
  
  input:focus{
    outline:none;
    border-color:var(--secondary);
    background:rgba(255,255,255,0.08);
  }
  
  /* Buttons */
  .btn{
    padding:12px 20px;
    border-radius:8px;
    border:none;
    font-weight:600;
    cursor:pointer;
    font-size:14px;
    transition:all 0.3s;
    display:inline-flex;
    align-items:center;
    gap:8px;
    justify-content:center;
  }
  
  .btn-primary{
    background:var(--accent-gradient);
    color:#fff;
  }
  
  .btn-primary:hover{
    transform:translateY(-2px);
    box-shadow:0 8px 24px rgba(102,126,234,0.4);
  }
  
  .btn-secondary{
    background:rgba(255,255,255,0.05);
    color:var(--text);
    border:1px solid var(--border);
  }
  
  .btn-secondary:hover{
    background:rgba(255,255,255,0.1);
  }
  
  .btn-success{
    background:var(--success);
    color:#fff;
  }
  
  .btn-warning{
    background:var(--warning);
    color:#fff;
  }
  
  .btn-group{
    display:flex;
    gap:12px;
    margin-top:12px;
  }
  
  .btn-group .btn{
    flex:1;
  }
  
  /* Activity Log */
  .activity-list{
    max-height:400px;
    overflow-y:auto;
  }
  
  .activity-item{
    padding:12px;
    border-radius:8px;
    margin-bottom:8px;
    border-left:3px solid;
    transition:all 0.2s;
  }
  
  .activity-item:hover{
    transform:translateX(4px);
  }
  
  .activity-success{
    background:rgba(16,185,129,0.1);
    border-color:var(--success);
  }
  
  .activity-error{
    background:rgba(239,68,68,0.1);
    border-color:var(--danger);
  }
  
  .activity-message{
    font-size:14px;
    font-weight:500;
    margin-bottom:4px;
  }
  
  .activity-time{
    font-size:11px;
    color:var(--text-muted);
  }
  
  .empty-activity{
    text-align:center;
    padding:40px 20px;
    color:var(--text-muted);
  }
  
  /* Info Cards */
  .info-card{
    background:rgba(139,92,246,0.1);
    border:1px solid rgba(139,92,246,0.3);
    border-radius:8px;
    padding:16px;
    margin-bottom:16px;
  }
  
  .info-card h4{
    margin:0 0 8px;
    padding:0;
    border:none;
    font-size:14px;
    color:var(--secondary);
  }
  
  .info-card p{
    margin:0;
    font-size:13px;
    line-height:1.6;
  }
  
  .stats-grid{
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:12px;
    margin-bottom:16px;
  }
  
  .stat-box{
    background:rgba(255,255,255,0.03);
    padding:16px;
    border-radius:8px;
    text-align:center;
  }
  
  .stat-value{
    font-size:32px;
    font-weight:700;
    color:var(--secondary);
  }
  
  .stat-label{
    font-size:12px;
    color:var(--text-muted);
    text-transform:uppercase;
    letter-spacing:0.5px;
  }
  
  /* Responsive */
  @media(max-width:1024px){
    .grid{
      grid-template-columns:1fr;
    }
  }
  
  @media(max-width:640px){
    nav{
      display:none;
    }
    
    .page-header h2{
      font-size:24px;
    }
    
    .btn-group{
      flex-direction:column;
    }
    
    .stats-grid{
      grid-template-columns:1fr;
    }
  }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="logo">
      <div class="logo-icon">E</div>
      <h1>EventPass</h1>
    </div>
    <nav>
        <a href="index.html">Home</a>
      <a href="events.html">Events</a>
      <a href="dashboard.html">Dashboard</a>
      <a href="admin.html">Admin</a>
    </nav>
  </header>

  <div class="page-header">
    <h2>üì± Gate Scanner</h2>
    <p>Scan QR codes to verify and check-in attendees</p>
  </div>

  <div class="grid">
    <main>
      <!-- Scanner Card -->
      <div class="card">
        <h3>üì∑ Live QR Scanner</h3>
        <div id="reader"></div>
        <div id="scanResult" class="scan-status status-idle">
          Ready to scan...
        </div>
        
        <div id="offlineBadge" style="display:none" class="offline-badge">
          <span class="pulse-dot"></span>
          <span id="offlineCount">0 scans pending sync</span>
        </div>
        
        <div class="btn-group">
          <button class="btn btn-warning" onclick="syncOffline()">
            üîÑ Sync Offline Scans
          </button>
        </div>
      </div>

      <!-- Manual Verify Card -->
      <div class="card">
        <h3>‚å®Ô∏è Manual Verification</h3>
        <div class="form-group">
          <label>QR Token or Ticket ID</label>
          <input id="manualToken" placeholder="Paste token or enter ticket ID">
        </div>
        <div class="btn-group">
          <button class="btn btn-primary" onclick="manualVerify()">
            ‚úì Verify
          </button>
          <button class="btn btn-secondary" onclick="searchByPhone()">
            üîç Search by Phone
          </button>
        </div>
      </div>

      <!-- Activity Log Card -->
      <div class="card">
        <h3>üìä Recent Activity</h3>
        <div id="activity" class="activity-list">
          <div class="empty-activity">No scan activity yet</div>
        </div>
      </div>
    </main>

    <aside>
      <!-- Stats Card -->
      <div class="card">
        <h3>üìà Session Stats</h3>
        <div class="stats-grid">
          <div class="stat-box">
            <div class="stat-value" id="successCount">0</div>
            <div class="stat-label">Successful</div>
          </div>
          <div class="stat-box">
            <div class="stat-value" id="failedCount">0</div>
            <div class="stat-label">Failed</div>
          </div>
        </div>
      </div>

      <!-- Info Card -->
      <div class="card">
        <h3>‚ÑπÔ∏è Scanner Info</h3>
        
        <div class="info-card">
          <h4>üîå Offline Mode</h4>
          <p>Scans are saved locally when offline. Use "Sync Offline Scans" to upload when connection returns.</p>
        </div>
        
        <div class="info-card">
          <h4>üö´ Duplicate Prevention</h4>
          <p>Each QR code can only be scanned once. Duplicate attempts are automatically blocked.</p>
        </div>
        
        <div class="info-card">
          <h4>‚ö° Quick Tips</h4>
          <p>‚Ä¢ Hold QR code steady in frame<br>
          ‚Ä¢ Ensure good lighting<br>
          ‚Ä¢ Keep 6-12 inches away<br>
          ‚Ä¢ Use manual entry if needed</p>
        </div>
      </div>
    </aside>
  </div>
</div>

<!-- html5-qrcode library -->
<script src="https://unpkg.com/html5-qrcode"></script>
<script>
const API_BASE = "http://localhost:5000/api";
const offlineKey = 'eventpass_offline_scans';
let activityLog = [];
let successCount = 0;
let failedCount = 0;
let isScanning = false;

function updateStats(){
  document.getElementById('successCount').textContent = successCount;
  document.getElementById('failedCount').textContent = failedCount;
}

function addActivity(msg, ok = true){
  activityLog.unshift({
    msg,
    ok,
    time: Date.now()
  });
  
  if(activityLog.length > 50) activityLog.pop();
  
  if(ok) successCount++;
  else failedCount++;
  
  updateStats();
  renderActivity();
}

function renderActivity(){
  const container = document.getElementById('activity');
  
  if(activityLog.length === 0){
    container.innerHTML = '<div class="empty-activity">No scan activity yet</div>';
    return;
  }
  
  const html = activityLog.map(a => {
    const className = a.ok ? 'activity-success' : 'activity-error';
    const timeStr = new Date(a.time).toLocaleTimeString();
    return `
      <div class="activity-item ${className}">
        <div class="activity-message">${escapeHtml(a.msg)}</div>
        <div class="activity-time">${timeStr}</div>
      </div>
    `;
  }).join('');
  
  container.innerHTML = html;
}

function offlinePush(token){
  const arr = JSON.parse(localStorage.getItem(offlineKey) || '[]');
  arr.push({token, ts: Date.now()});
  localStorage.setItem(offlineKey, JSON.stringify(arr));
  updateOfflineCount();
}

function updateOfflineCount(){
  const arr = JSON.parse(localStorage.getItem(offlineKey) || '[]');
  const badge = document.getElementById('offlineBadge');
  const countEl = document.getElementById('offlineCount');
  
  if(arr.length > 0){
    badge.style.display = 'inline-flex';
    countEl.textContent = `${arr.length} scan${arr.length === 1 ? '' : 's'} pending sync`;
  } else {
    badge.style.display = 'none';
  }
}

function setStatus(message, type = 'idle'){
  const resultEl = document.getElementById('scanResult');
  resultEl.textContent = message;
  resultEl.className = `scan-status status-${type}`;
}

async function onScanSuccess(token){
  if(isScanning) return; // Prevent multiple rapid scans
  isScanning = true;
  
  setStatus('üîÑ Validating ticket...', 'scanning');
  
  try {
    const res = await fetch(API_BASE + '/tickets/verify', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({token})
    });
    
    const data = await res.json();
    
    if(data.status === 'ok'){
      const name = data.ticket?.name || 'Attendee';
      const event = data.ticket?.event?.name || 'Event';
      setStatus(`‚úÖ ALLOWED - ${name}`, 'success');
      addActivity(`‚úÖ Check-in: ${name} ‚Üí ${event}`, true);
      
      // Play success sound (optional)
      playSound('success');
    } 
    else if(data.status === 'duplicate'){
      setStatus('üö´ DUPLICATE - Already checked in', 'error');
      addActivity(`üö´ Duplicate attempt: ${data.ticketId || 'Unknown'}`, false);
      playSound('error');
    } 
    else {
      setStatus('‚ùå INVALID - Token not recognized', 'error');
      addActivity('‚ùå Invalid token scanned', false);
      playSound('error');
    }
  } catch (err) {
    // Offline - store for later sync
    offlinePush(token);
    setStatus('üì° OFFLINE - Saved for sync', 'offline');
    addActivity('üì° Saved offline: Will sync when online', true);
  }
  
  // Reset after 3 seconds
  setTimeout(() => {
    if(!isScanning) return;
    setStatus('Ready to scan...', 'idle');
    isScanning = false;
  }, 3000);
}

async function manualVerify(){
  const val = document.getElementById('manualToken').value.trim();
  if(!val){
    alert('‚ö†Ô∏è Please enter a token or ticket ID');
    return;
  }
  
  // If looks like a JWT token (contains dots)
  if(val.split('.').length >= 3){
    await onScanSuccess(val);
  } else {
    // Treat as ticket ID - fetch and verify
    try{
      const r = await fetch(API_BASE + '/tickets/' + val);
      const d = await r.json();
      
      if(d.qrToken){
        await onScanSuccess(d.qrToken);
      } else {
        alert('‚ùå Ticket not found or no QR token available');
      }
    } catch(e){
      alert('‚ùå Lookup failed: ' + e.message);
    }
  }
  
  document.getElementById('manualToken').value = '';
}

async function syncOffline(){
  const arr = JSON.parse(localStorage.getItem(offlineKey) || '[]');
  
  if(!arr.length){
    alert('‚ÑπÔ∏è No offline scans to sync');
    return;
  }
  
  try {
    const tokens = arr.map(x => x.token);
    const res = await fetch(API_BASE + '/tickets/bulk-verify', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({tokens})
    });
    
    const data = await res.json();
    
    if(data.results){
      data.results.forEach(r => {
        if(r.status === 'ok'){
          addActivity(`üîÑ Synced: ${r.ticketId || 'Ticket'}`, true);
        } else if(r.status === 'duplicate'){
          addActivity(`üîÑ Synced (duplicate): ${r.ticketId || 'Ticket'}`, false);
        } else {
          addActivity('üîÑ Synced (invalid)', false);
        }
      });
    }
    
    localStorage.removeItem(offlineKey);
    updateOfflineCount();
    alert(`‚úÖ Successfully synced ${arr.length} scan${arr.length === 1 ? '' : 's'}!`);
  } catch(e) {
    alert('‚ùå Sync failed: ' + e.message);
  }
}

async function searchByPhone(){
  const phone = prompt('Enter phone number to search:');
  if(!phone) return;
  
  try{
    const res = await fetch(API_BASE + '/tickets/search?phone=' + encodeURIComponent(phone));
    const data = await res.json();
    
    if(Array.isArray(data) && data.length){
      const t = data[0];
      const token = t.qrToken;
      const msg = `Found ticket for ${t.name}\nEvent: ${t.event?.name || 'Unknown'}\nStatus: ${t.used ? 'Already checked in' : 'Active'}`;
      
      if(confirm(msg + '\n\nVerify this ticket now?')){
        await onScanSuccess(token);
      }
    } else {
      alert('‚ùå No tickets found for this phone number');
    }
  } catch(e){
    alert('‚ùå Search failed: ' + e.message);
  }
}

function playSound(type){
  // Optional: Add sound effects
  // Can use Web Audio API or HTML5 Audio
}

function escapeHtml(s){
  const div = document.createElement('div');
  div.textContent = s;
  return div.innerHTML;
}

// Initialize html5-qrcode
const html5QrCode = new Html5Qrcode("reader");

Html5Qrcode.getCameras().then(cameras => {
  if(cameras && cameras.length){
    const cameraId = cameras[0].id;
    
    html5QrCode.start(
      cameraId,
      {
        fps: 10,
        qrbox: {width: 300, height: 300}
      },
      (decodedText) => {
        onScanSuccess(decodedText);
      },
      (errorMessage) => {
        // Ignore continuous scanning errors
      }
    ).catch(err => {
      console.error('Camera start error:', err);
      setStatus('‚ùå Camera failed to start', 'error');
    });
  } else {
    setStatus('üì∑ No camera found', 'error');
  }
}).catch(err => {
  console.error('Camera permission error:', err);
  setStatus('üö´ Camera permission denied', 'error');
});

// Initialize
updateOfflineCount();
renderActivity();
updateStats();
</script>
</body>
</html>